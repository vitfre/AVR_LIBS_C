/*
 * _4094.c
 *
 * Created: 17.05.2014 17:43:16
 *  Author: Администратор
 */ 

#include "4094.h"

//Таблица цифр для семисегментника
unsigned char led_table[10] ={0b11000000,0b11111001,0b10100100,0b10110000,0b10011001,0b10010010,0b10000010,0b11111000,0b10000000,0b10010000};
//unsigned char const led_table[10] PROGMEM ={0b00111111,0b00000110,0b01011011,0b01001111,0b01100110,0b01101101,0b01111101,0b00000111,0b01111111,0b01101111};
unsigned char sig_table[3] ={0b11111111,0b10000110,0b10111111};
//****************************************************************************************
//Пихаємо розряд в регістр
//****************************************************************************************
void send_byte(unsigned char data)
{
	for (unsigned char i=9;i>1;i--)
	{
		
		if ((((data)>>(i-2))&1))
		{
			SET_DATA
		}
		else
		{
			CLR_DATA
		};
		_delay_us(5);
		SET_CLK
		_delay_us(5);
		CLR_CLK
	};
};
//****************************************************************************************
//Конвертор із BCD в 7SEG
//****************************************************************************************
//Тут творяться не менші дива)))
void bcd_to_7seg(unsigned char segment)
{
	//---------------------------------------------------------------------------------------
	switch (segment)		// просто оператор switch..
	{
		case 0x0A :
		{
			//---------------------------------------------------------------------------------------
			send_byte(sig_table[0]);//Пихаємо гасячий розряд в регістр
			//---------------------------------------------------------------------------------------
		};
		break;
		case 0x0B :
		{
			//---------------------------------------------------------------------------------------
			send_byte(sig_table[1]);//Пихаємо знак Е в регістр
			//---------------------------------------------------------------------------------------
		};
		break;
		case 0x0C :
		{
			//---------------------------------------------------------------------------------------
			send_byte(sig_table[2]);//Пихаємо знак Е в регістр
			//---------------------------------------------------------------------------------------
		};
		break;
		case 0x0D :
		{
			//---------------------------------------------------------------------------------------
			
			//---------------------------------------------------------------------------------------
		};
		break;
		case 0x0E :
		{
			//---------------------------------------------------------------------------------------
			
			//---------------------------------------------------------------------------------------
		};
		break;
		default :
		{
			//---------------------------------------------------------------------------------------
			send_byte(led_table[segment]);//Пихаємо розряд в регістр але перед тим конвертуємо цифру в 7-сегментний код
			//---------------------------------------------------------------------------------------
		};
	};   //switch (segment)
	//---------------------------------------------------------------------------------------
};
//****************************************************************************************
//Конвертор із BIN в BCD
//****************************************************************************************
//Тут творяться дива)))
void bin_to_bcd(signed int temp, unsigned int humid, unsigned int pres)
{
	//---------------------------------------------------------------------------------------
	CLR_ENABLE//гасимо екран
	//---------------------------------------------------------------------------------------
	if (temp==(-21))
	{
		for (unsigned char i=0;i<3;i++)
		{
			bcd_to_7seg(0x0A);//Пихаємо розряд в регістр
		};
		bcd_to_7seg(0x0B);//Пихаємо розряд в регістр
	} 
	else
	{
		//---------------------------------------------------------------------------------------
		if (temp>=0)
		{
			for (unsigned char i=0;i<4;i++)
			{
				bcd_to_7seg(temp%10);//Пихаємо розряд в регістр
				temp/=10; //Сдвигаем разряд вправо
			};
		} 
		else
		{
			temp=temp*(-1);
			for (unsigned char i=0;i<3;i++)
			{
				bcd_to_7seg(temp%10);//Пихаємо розряд в регістр
				temp/=10; //Сдвигаем разряд вправо
			};
			//---------------------------------------------------------------------------------------
			//---------------------------------------------------------------------------------------
			//---------------------------------------------------------------------------------------
			//---------------------------------------------------------------------------------------
			bcd_to_7seg(0x0C);//Пихаємо розряд в регістр
		}
		//---------------------------------------------------------------------------------------
	};
	//---------------------------------------------------------------------------------------
	if (humid==0)
	{
		for (unsigned char i=0;i<3;i++)
		{
			bcd_to_7seg(0x0A);//Пихаємо розряд в регістр
		};
		bcd_to_7seg(0x0B);//Пихаємо розряд в регістр
	}
	else
	{
		//---------------------------------------------------------------------------------------
		for (unsigned char i=0;i<4;i++)
		{
			bcd_to_7seg(humid%10);//Пихаємо розряд в регістр
			humid/=10; //Сдвигаем разряд вправо
		};
		//---------------------------------------------------------------------------------------
	};
	//---------------------------------------------------------------------------------------
	if (pres==0)
	{
		for (unsigned char i=0;i<3;i++)
		{
			bcd_to_7seg(0x0A);//Пихаємо розряд в регістр
		};
		bcd_to_7seg(0x0B);//Пихаємо розряд в регістр
	}
	else
	{
		//---------------------------------------------------------------------------------------
		for (unsigned char i=0;i<4;i++)
		{
			bcd_to_7seg(pres%10);//Пихаємо розряд в регістр
			pres/=10; //Сдвигаем разряд вправо
		};
		//---------------------------------------------------------------------------------------
	};
	//---------------------------------------------------------------------------------------
	SET_STROB//Зберігаємо дані в регістрах
	SET_ENABLE//Запалюємо екран
	//---------------------------------------------------------------------------------------
};