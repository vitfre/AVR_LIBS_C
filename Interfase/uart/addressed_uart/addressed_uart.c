/*
 * addressed_uart.c
 *
 * Created: 06.02.2015 17:48:14
 *  Author: Администратор
 */ 

#include "addressed_uart.h"

//****************************************************************************************
ISR(USART_RXC_vect)
{
	//---------------------------------------------------------------------------------------
	uint8_t byte = UDR;
	//---------------------------------------------------------------------------------------
	switch (receive_state)
	{
		case _READY_ :
		{
			//------------------------------------------------------------------------------------------------------------------------------------------
			if (byte==_START_)
			{
				//---------------------------------------------------------------------------------------
				receive_state=_FOUND_START_;
				//---------------------------------------------------------------------------------------
			}
			else
			{
				//---------------------------------------------------------------------------------------
				
				//---------------------------------------------------------------------------------------
			};
			//------------------------------------------------------------------------------------------------------------------------------------------
		}
		break;
		case _FOUND_START_ :
		{
			//------------------------------------------------------------------------------------------------------------------------------------------
			if (byte==_ADDRES_)
			{
				//---------------------------------------------------------------------------------------
				receive_state=_FOUND_ADDRES_;
				//---------------------------------------------------------------------------------------
			}
			else
			{
				//---------------------------------------------------------------------------------------
				
				//---------------------------------------------------------------------------------------
			};
			//------------------------------------------------------------------------------------------------------------------------------------------
		}
		break;
		case _FOUND_ADDRES_ :
		{
			//------------------------------------------------------------------------------------------------------------------------------------------
			if ((byte==_FOUND_TX_)||(byte==_FOUND_RX_)||(byte==_FOUND_COMM_))
			{
				//---------------------------------------------------------------------------------------
				receive_state=byte;
				//---------------------------------------------------------------------------------------
			}
			else
			{
				//---------------------------------------------------------------------------------------
				receive_state=_READY_;
				//---------------------------------------------------------------------------------------
			};
			//------------------------------------------------------------------------------------------------------------------------------------------
		}
		break;
		case _FOUND_TX_ :
		{
			//------------------------------------------------------------------------------------------------------------------------------------------
			begin_u = byte>>8;
			length_u = byte&0x0F;
			//---------------------------------------------------------------------------------------
			receive_state=_WAIT_RX_;
			
			//OF_LED
			//OF_LED_2
			//------------------------------------------------------------------------------------------------------------------------------------------
		}
		break;
		case _FOUND_RX_ :
		{
			//------------------------------------------------------------------------------------------------------------------------------------------
			begin_u = byte>>8;
			length_u = byte&0x0F;
			//---------------------------------------------------------------------------------------
			receive_state=_WAIT_RESTART_;
			//ON_LED
			//ON_LED_2
			//------------------------------------------------------------------------------------------------------------------------------------------
		}
		break;
		
		case _FOUND_COMM_ :
		{
			//------------------------------------------------------------------------------------------------------------------------------------------
			switch (byte)
			{
				case _ON_LAMP_ :
				{
					//---------------------------------------------------------------------------------------
					//---------------------------------------------------------------------------------------
					//---------------------------------------------------------------------------------------
					_COMMAND_LON_
					//---------------------------------------------------------------------------------------
					//---------------------------------------------------------------------------------------
					//---------------------------------------------------------------------------------------
				}
				break;
				case _OF_LAMP_ :
				{
					//---------------------------------------------------------------------------------------
					//---------------------------------------------------------------------------------------
					//---------------------------------------------------------------------------------------
					_COMMAND_LOF_
					//---------------------------------------------------------------------------------------
					//---------------------------------------------------------------------------------------
					//---------------------------------------------------------------------------------------
				}
				break;
				default:
				{
					//---------------------------------------------------------------------------------------
					
					//---------------------------------------------------------------------------------------
				};
				receive_state=_WAIT_STOP_;
			}; //switch (byte)
			//------------------------------------------------------------------------------------------------------------------------------------------
		}
		break;
		case _WAIT_STOP_ :
		{
			//------------------------------------------------------------------------------------------------------------------------------------------
			if (byte==_STOP_)
			{
				//---------------------------------------------------------------------------------------
				receive_state=_READY_;
				//---------------------------------------------------------------------------------------
			}
			else
			{
				//---------------------------------------------------------------------------------------
				
				//---------------------------------------------------------------------------------------
			};
			//------------------------------------------------------------------------------------------------------------------------------------------
		}
		break;
		case _WAIT_RESTART_ :
		{
			//------------------------------------------------------------------------------------------------------------------------------------------
			
			//---------------------------------------------------------------------------------------
			if (byte==_RESTART_)
			{
				//---------------------------------------------------------------------------------------
				receive_state=_READY_TX_;
				//OF_LED
				//OF_LED_2
				//---------------------------------------------------------------------------------------
			}
			else
			{
				//---------------------------------------------------------------------------------------
				
				//---------------------------------------------------------------------------------------
			};
			//------------------------------------------------------------------------------------------------------------------------------------------
		}
		break;
		default:
		{
			//---------------------------------------------------------------------------------------
			
			//---------------------------------------------------------------------------------------
		};
	}; //switch ()
	//---------------------------------------------------------------------------------------
};

//****************************************************************************************
ISR(USART_UDRE_vect)
{
	//---------------------------------------------------------------------------------------
	uint8_t rd = uart_txrd;
	if(rd != uart_txwr)
	{
		//---------------------------------------------------------------------------------------
		UDR = uart_tx[rd];
		uart_txrd = (rd+1) & UART_BUFEND;
		return;
		//---------------------------------------------------------------------------------------
	};
	UCSRB &= ~(1<<UDRIE);
	//---------------------------------------------------------------------------------------
};
//****************************************************************************************
uint8_t receive_state_()
{
	//---------------------------------------------------------------------------------------
	return receive_state;
	//---------------------------------------------------------------------------------------
};
//****************************************************************************************
uint8_t uart_rx_count()
{
	//---------------------------------------------------------------------------------------
	return (uart_rxwr-uart_rxrd) & UART_BUFEND;
	//---------------------------------------------------------------------------------------
};
//****************************************************************************************
uint8_t uart_read()
{
	//---------------------------------------------------------------------------------------
	uint8_t rd = uart_rxrd;
	//uint8_t byte;
	if(rd != uart_rxwr)
	{
		//---------------------------------------------------------------------------------------
		uint8_t byte = uart_rx[rd];
		uart_rxrd = (rd+1) & UART_BUFEND;
		return byte;
		//---------------------------------------------------------------------------------------
	};
	return 0;
	//---------------------------------------------------------------------------------------
};
//****************************************************************************************
void uart_write(uint8_t byte)
{
	//---------------------------------------------------------------------------------------
	uint8_t wr = (uart_txwr+1) & UART_BUFEND;
	//---------------------------------------------------------------------------------------
	if(wr != uart_txrd)
	{
		//---------------------------------------------------------------------------------------
		uart_tx[uart_txwr] = byte;
		uart_txwr = wr;
		UCSRB |= (1<<UDRIE);
		//---------------------------------------------------------------------------------------
	};
	//---------------------------------------------------------------------------------------
};
//****************************************************************************************
void uart_init()
{
	//---------------------------------------------------------------------------------------
	UBRRL = F_CPU/UART_BAUD_RATE/16-1;
	UBRRH = (F_CPU/UART_BAUD_RATE/16-1)>>8;
	UCSRB = (1<<RXCIE)|(1<<RXEN)|(1<<TXEN);
	//---------------------------------------------------------------------------------------
	//packet_received=_NOT_FOUND_;
	receive_state = _READY_;
	//---------------------------------------------------------------------------------------
};
//****************************************************************************************
//****************************************************************************************
//****************************************************************************************