/*
 * MLX90316.c
 *
 * Created: 26.09.2014 19:25:03
 *  Author: Администратор
 */ 

#include "ref_angle_sensor.h"

//---------------------------------------------------------------------------------------
#if ((_MLX_ == 1)&(_TLE_ == 0))
//---------------------------------------------------------------------------------------
/**************************************************************************
*   Function name : sens_send_data
*   Returns :       нема
*   Parameters :    Байт
*   Purpose :       Відправка байта на опорний датчик
****************************************************************************/
void sens_send_data(unsigned char data)
{
	//---------------------------------------------------------------------------------------
	unsigned char temp_bit, divider, lich;
	divider=0x80;
	lich=1;
	while (lich<=8)
	{
		//---------------------------------------------------------------------------------------
		CLK_HI
		_delay_us(10);
		temp_bit=data/divider;
		data=data%divider;
		divider=divider/2;
		//---------------------------------------------------------------------------------------
		if (temp_bit==1)
		{
			//---------------------------------------------------------------------------------------
			DATA_HI
			//---------------------------------------------------------------------------------------
		}
		else
		{
			//---------------------------------------------------------------------------------------
			DATA_LO
			//---------------------------------------------------------------------------------------
		};
		//---------------------------------------------------------------------------------------
		CLK_LO
		_delay_us(10);
		lich++;
		//---------------------------------------------------------------------------------------
	};	
	//---------------------------------------------------------------------------------------	
};
/**************************************************************************
*   Function name : sens_get_angle
*   Returns :       кут отриманий від опорного датчика
*   Parameters :    нема
*   Purpose :       Функція зчитування опорного датчика
****************************************************************************/
unsigned int get_angle(void)
{
	//---------------------------------------------------------------------------------------
	unsigned char lich=1;
	unsigned int data=0;
	//---------------------------------------------------------------------------------------
	CS_LO
	_delay_us(7);
	//TX MLX data
	sens_send_data(0xAA);					//Synhrobit
	sens_send_data(0xFF);					//FF Datasheet
	_delay_us(50);
	//RX MLX data
	DATA_IN//Set port to input
	//---------------------------------------------------------------------------------------
	while (lich<=16)
	{
		CLK_HI
		_delay_us(10);
		data=data<<1;
		data=data+(GET_DATA);
		lich++;
		CLK_LO
		_delay_us(10);
	};
	//---------------------------------------------------------------------------------------
	data=data>>2;
	//---------------------------------------------------------------------------------------
	DATA_LO
	DATA_OUT					//Set port to output
	_delay_us(10);
	CS_HI
	return data;
	//---------------------------------------------------------------------------------------
};
//---------------------------------------------------------------------------------------
#elif ((_MLX_ == 0)&(_TLE_ == 1))
//---------------------------------------------------------------------------------------
/**************************************************************************
*   Function name : sens_send_data
*   Returns :       нема
*   Parameters :    Байт
*   Purpose :       Відправка байта на опорний датчик
****************************************************************************/
void sens_send_data(unsigned int data)
{
	//---------------------------------------------------------------------------------------
	unsigned char temp_bit=0;
	unsigned int divider=0x8000;
	//---------------------------------------------------------------------------------------
	for (unsigned char lich=1;lich<=16;lich++)
	{
		//---------------------------------------------------------------------------------------
		CLK_HI
		temp_bit=data/divider;
		data=data%divider;
		divider=divider/2;
		//---------------------------------------------------------------------------------------
		if (temp_bit==1)
		{
			//---------------------------------------------------------------------------------------
			DATA_HI
			//---------------------------------------------------------------------------------------
		} 
		else
		{
			//---------------------------------------------------------------------------------------
			DATA_LO
			//---------------------------------------------------------------------------------------
		};
		//---------------------------------------------------------------------------------------
		_delay_us(1);
		CLK_LO
		_delay_us(1);
		//---------------------------------------------------------------------------------------
	};
	//---------------------------------------------------------------------------------------
};
/**************************************************************************
*   Function name : sens_get_angle
*   Returns :       кут отриманий від опорного датчика
*   Parameters :    нема
*   Purpose :       Функція зчитування опорного датчика
****************************************************************************/
unsigned int get_angle(void)
{
	//---------------------------------------------------------------------------------------
	unsigned char lich=1;
	unsigned int data=0;
	//---------------------------------------------------------------------------------------
	CS_LO
	_delay_us(1);
	//TX TLE data
	sens_send_data(0x8021);					//
	_delay_us(1);
	//RX TLE data
	DATA_IN//Set port to input
	//---------------------------------------------------------------------------------------
	while (lich<=16)
	{
		CLK_HI
		_delay_us(1);
		data=data<<1;
		data=data+(GET_DATA);
		lich++;
		CLK_LO
		_delay_us(1);
	};
	//---------------------------------------------------------------------------------------
	lich=1;
	while (lich<=16)
	{
		CLK_HI
		_delay_us(1);

		lich++;
		CLK_LO
		_delay_us(1);
	};
	//---------------------------------------------------------------------------------------
	(data&=~(1<<15));
	#ifdef _SMC_05_
		data=32768-data;
	#endif
	//data=data>>1;
	//---------------------------------------------------------------------------------------
	DATA_LO
	DATA_OUT					//Set port to output
	_delay_us(1);
	CS_HI
	_delay_us(1);
	//---------------------------------------------------------------------------------------
	return data;
	//---------------------------------------------------------------------------------------
};
//---------------------------------------------------------------------------------------
#endif
/**************************************************************************
*   Function name : sens_get_average_angle
*   Returns :       кут отриманий від опорного датчика
*   Parameters :    нема
*   Purpose :       Функція зчитування середнього арифметичного з 4х вимірів опорного датчика
****************************************************************************/
unsigned long int get_average_angle(void)
{
	unsigned long int data = 0;
	data=get_angle();
	_delay_ms(1);
	data=data + get_angle();
	_delay_ms(1);
	data=data + get_angle();
	_delay_ms(1);
	data=data + get_angle();
	data=data>>2;
	return data;
};
//***************************************************************************************
//***************************************************************************************
//***************************************************************************************