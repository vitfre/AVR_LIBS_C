/*
 * HC_SR04.c
 *
 * Created: 08.11.2013 8:08:35
 *  Author: Администратор
 */ 

#include "HC_SR04.h"

//****************************************************************************************
//Преривание по переполнению таймера 0
//****************************************************************************************
ISR (TIMER0_OVF_vect)
{
	if (dn==1)
	{
		//---------------------------------------------------------------------------------------
		TCNT0=0x00;
		//---------------------------------------------------------------------------------------
		TCNT1H=0x00;
		TCNT1L=0x00;
		//---------------------------------------------------------------------------------------
		TRIG_SET
		TCCR1B=0x01;
		//---------------------------------------------------------------------------------------
		dn=0;
	} 
	else
	{
		dn=1;
	};
	return;
};

//****************************************************************************************
//Преривание по переполнению таймера 1
//****************************************************************************************
ISR (TIMER1_OVF_vect)
{
	TCCR1B=0x00;
	TCNT1H=0x00;
	TCNT1L=0x00;
	return;
};

//****************************************************************************************
//Преривание по приходу ехо
//****************************************************************************************
ISR (INT0_vect)
{
	unsigned int tmin=0,tmax=0,data=0;
	//_delay_us(1);
	if (DIN==1)
	{
		tmin = TCNT1;
		while(DIN==1)
		{
		};
		tmax =  TCNT1;
		data = tmax - tmin;
	} 
	else
	{
	};
	if (FILTR==0)
	{
		time_eho = filter(data); //Фільтруєм
	}
	else
	{
		time_eho = data;	//Не фільтруєм
	};
	return;
};

int main(void)
{
	init_mcu();
	init_LCD();
	uart_init();
	// Global enable interrupts
	sei();
    while(1)
    {
        //TODO:: Please write your application code
		Main_menu (0x00,time_eho);
		//=================================================================
		uart_write(time_eho>>8);
		uart_write(time_eho);
		//=================================================================
		_delay_ms(100);
    };
};